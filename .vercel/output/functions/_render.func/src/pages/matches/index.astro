---
import Layout from '../../layouts/Layout.astro';
import { db } from '../../db';
import { getCivilizationName } from '../../lib/civilizations';

// PaginaciÃ³n
const ITEMS_PER_PAGE = 5;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');

// Obtener todas las partidas y ordenar por fecha descendente
const allMatchesRaw = await db.matches.findAll();
const allMatches = allMatchesRaw.sort((a, b) =>
  new Date(b.playedAt).getTime() - new Date(a.playedAt).getTime()
);

const totalMatches = allMatches.length;
const totalPages = Math.ceil(totalMatches / ITEMS_PER_PAGE);
const validPage = Math.max(1, Math.min(currentPage, totalPages || 1));

// Obtener partidas de la pÃ¡gina actual
const startIndex = (validPage - 1) * ITEMS_PER_PAGE;
const paginatedMatches = allMatches.slice(startIndex, startIndex + ITEMS_PER_PAGE);

const matchesWithParticipants = [];
for (const match of paginatedMatches) {
  const rawParticipants = await db.participants.findByMatchId(match.id);
  const participants = [];
  for (const p of rawParticipants) {
    const player = await db.users.findById(p.playerId);
    participants.push({ ...p, playerName: player?.username || 'Unknown' });
  }
  matchesWithParticipants.push({ ...match, participants });
}

// Generar array de pÃ¡ginas para mostrar
const getPageNumbers = () => {
  const pages: (number | string)[] = [];
  if (totalPages <= 7) {
    for (let i = 1; i <= totalPages; i++) pages.push(i);
  } else {
    if (validPage <= 3) {
      pages.push(1, 2, 3, 4, '...', totalPages);
    } else if (validPage >= totalPages - 2) {
      pages.push(1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages);
    } else {
      pages.push(1, '...', validPage - 1, validPage, validPage + 1, '...', totalPages);
    }
  }
  return pages;
};
---

<Layout title="Historial de Partidas">
  <div class="space-y-8">
    <div class="text-center">
      <h1 class="aoe-title text-3xl mb-2">Historial de Partidas</h1>
      <p class="text-aoe-cream-dark mb-4">{totalMatches} partidas registradas</p>
      <a href="/matches/new" class="aoe-btn-primary">+ Nueva Partida</a>
    </div>

    {totalMatches === 0 ? (
      <div class="aoe-panel text-center py-12">
        <span class="text-6xl mb-4 block">ğŸ“œ</span>
        <h2 class="aoe-title text-xl mb-2">Sin partidas</h2>
        <p class="text-aoe-cream-dark mb-4">No hay partidas registradas aÃºn</p>
        <a href="/matches/new" class="aoe-btn-primary inline-block">Registrar Primera Partida</a>
      </div>
    ) : (
      <>
        <div class="space-y-4">
          {matchesWithParticipants.map((match) => {
            const winners = match.participants.filter(p => p.isWinner);
            const losers = match.participants.filter(p => !p.isWinner);
            return (
              <div class="aoe-panel">
                <div class="flex justify-between items-start mb-4">
                  <div class="flex items-center gap-4">
                    <span class="text-2xl">{match.matchType === '1v1' ? 'âš”ï¸' : match.matchType === 'ffa' ? 'ğŸ‘‘' : 'âš”ï¸âš”ï¸'}</span>
                    <div>
                      <span class="font-cinzel text-lg text-aoe-gold uppercase">{match.matchType}</span>
                      <p class="text-sm text-aoe-cream-dark">{new Date(match.playedAt).toLocaleDateString('es', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-green-900/20 border border-green-500/30 rounded p-4">
                    <h4 class="text-green-400 font-semibold mb-3 flex items-center gap-2">
                      <span>ğŸ†</span>{winners.length > 1 ? 'Equipo Ganador' : 'Ganador'}
                    </h4>
                    <div class="space-y-2">
                      {winners.map((p) => (
                        <div class="flex justify-between items-center">
                          <div>
                            <a href={`/players/${p.playerId}`} class="text-aoe-cream hover:text-aoe-gold">{p.playerName}</a>
                            <span class="text-xs text-aoe-cream-dark ml-2">({getCivilizationName(p.civilization)})</span>
                          </div>
                          <span class="text-green-400 text-sm font-semibold">+{Math.round(p.eloChange)}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div class="bg-red-900/20 border border-red-500/30 rounded p-4">
                    <h4 class="text-red-400 font-semibold mb-3 flex items-center gap-2">
                      <span>ğŸ’€</span>{losers.length > 1 ? (match.matchType === 'ffa' ? 'Perdedores' : 'Equipo Perdedor') : 'Perdedor'}
                    </h4>
                    <div class="space-y-2">
                      {losers.map((p) => (
                        <div class="flex justify-between items-center">
                          <div>
                            <a href={`/players/${p.playerId}`} class="text-aoe-cream hover:text-aoe-gold">{p.playerName}</a>
                            <span class="text-xs text-aoe-cream-dark ml-2">({getCivilizationName(p.civilization)})</span>
                          </div>
                          <span class="text-red-400 text-sm font-semibold">{Math.round(p.eloChange)}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {totalPages > 1 && (
          <div class="flex justify-center items-center gap-2 mt-8">
            {validPage > 1 ? (
              <a
                href={`/matches?page=${validPage - 1}`}
                class="px-3 py-2 rounded bg-aoe-dark border border-aoe-gold/30 text-aoe-cream hover:bg-aoe-gold/20 transition-colors"
              >
                â† Anterior
              </a>
            ) : (
              <span class="px-3 py-2 rounded bg-aoe-dark/50 border border-aoe-gold/10 text-aoe-cream-dark cursor-not-allowed">
                â† Anterior
              </span>
            )}

            <div class="flex gap-1">
              {getPageNumbers().map((page) => (
                typeof page === 'number' ? (
                  <a
                    href={`/matches?page=${page}`}
                    class={`w-10 h-10 flex items-center justify-center rounded border transition-colors ${
                      page === validPage
                        ? 'bg-aoe-gold text-aoe-dark font-bold border-aoe-gold'
                        : 'bg-aoe-dark border-aoe-gold/30 text-aoe-cream hover:bg-aoe-gold/20'
                    }`}
                  >
                    {page}
                  </a>
                ) : (
                  <span class="w-10 h-10 flex items-center justify-center text-aoe-cream-dark">
                    {page}
                  </span>
                )
              ))}
            </div>

            {validPage < totalPages ? (
              <a
                href={`/matches?page=${validPage + 1}`}
                class="px-3 py-2 rounded bg-aoe-dark border border-aoe-gold/30 text-aoe-cream hover:bg-aoe-gold/20 transition-colors"
              >
                Siguiente â†’
              </a>
            ) : (
              <span class="px-3 py-2 rounded bg-aoe-dark/50 border border-aoe-gold/10 text-aoe-cream-dark cursor-not-allowed">
                Siguiente â†’
              </span>
            )}
          </div>
        )}

        {totalPages > 1 && (
          <p class="text-center text-aoe-cream-dark text-sm">
            Pagina {validPage} de {totalPages}
          </p>
        )}
      </>
    )}
  </div>
</Layout>
