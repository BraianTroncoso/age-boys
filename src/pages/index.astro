---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';
import { getRatingTier, getTierColor } from '../lib/elo';
import { getCivilizationName, getCivilizationFlag } from '../lib/civilizations';
import { getWeeklyLoser, getWeeklyPollera } from '../lib/stats';

// Obtener el filtro de ranking de la URL
const url = new URL(Astro.request.url);
const rankingType = url.searchParams.get('ranking') || '1v1';

// Mapear el tipo de ranking al campo de ELO
const eloFieldMap: Record<string, 'eloRating' | 'eloTeams' | 'eloFfa'> = {
  '1v1': 'eloRating',
  'teams': 'eloTeams',
  'ffa': 'eloFfa'
};
const eloField = eloFieldMap[rankingType] || 'eloRating';

const players = await db.users.findAllPlayers(eloField);
const allMatchesRaw = await db.matches.findAll();
const matches = allMatchesRaw.slice(0, 5);

// El boludo de la semana
const weeklyLoser = await getWeeklyLoser();

// El pollera de la semana
const weeklyPollera = await getWeeklyPollera();

// El rey del ranking
const topPlayer = players.length > 0 ? players[0] : null;

// Calcular stats del top player
let topPlayerStats = null;
if (topPlayer) {
  let wins = 0;
  let losses = 0;

  for (const match of allMatchesRaw) {
    const participants = await db.participants.findByMatchId(match.id);
    const playerParticipant = participants.find(p => p.playerId === topPlayer.id);
    if (playerParticipant) {
      if (playerParticipant.isWinner) wins++;
      else losses++;
    }
  }

  topPlayerStats = {
    wins,
    losses,
    total: wins + losses,
    winRate: wins + losses > 0 ? Math.round((wins / (wins + losses)) * 100) : 0
  };
}

// Frases picantes para el #1
const frasesTop = [
  "El que tiene la pija m√°s grande del grupo",
  "27cm de pura habilidad",
  "El √∫nico que sabe jugar ac√°",
  "Dios del Age, humilde y sencillo",
  "El que te garcha en el Age y en la vida",
  "Poronga at√≥mica del ranking",
  "El m√°s capo, el m√°s fachero, el mejor",
  "Se coge a todos sin despeinarse",
  "El que manda en esta mierda",
  "Alfa del grupo, los dem√°s son betas",
  "El √∫nico con neuronas funcionales",
  "Chad supremo del Age of Empires",
  "Tu pap√° en el Age",
  "El que te adopta como hijo",
];

const fraseRandom = frasesTop[Math.floor(Math.random() * frasesTop.length)];

const matchesWithParticipants = [];
for (const match of matches) {
  const rawParticipants = await db.participants.findByMatchId(match.id);
  const participants = [];
  for (const p of rawParticipants) {
    const player = await db.users.findById(p.playerId);
    participants.push({ ...p, playerName: player?.username || 'Unknown' });
  }
  matchesWithParticipants.push({ ...match, participants });
}
---

<Layout title="Rankings">
  <div class="space-y-4 sm:space-y-8">
    <!-- Secci√≥n del #1 - El Rey -->
    {topPlayer && topPlayerStats && (
      <div class="aoe-panel relative overflow-hidden">
        <!-- Fondo decorativo -->
        <div class="absolute inset-0 bg-gradient-to-r from-aoe-gold/10 via-transparent to-aoe-gold/10"></div>
        <div class="absolute top-0 left-0 w-24 sm:w-32 h-24 sm:h-32 bg-aoe-gold/5 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 right-0 w-32 sm:w-40 h-32 sm:h-40 bg-aoe-gold/5 rounded-full translate-x-1/2 translate-y-1/2"></div>

        <div class="relative">
          <div class="text-center mb-4 sm:mb-6">
            <span class="text-4xl sm:text-6xl">üëë</span>
            <h2 class="aoe-title text-xl sm:text-2xl text-aoe-gold mt-2">EL N√öMERO 1</h2>
            <p class="text-aoe-cream-dark text-xs sm:text-sm italic px-2">"{fraseRandom}"</p>
          </div>

          <div class="flex flex-col items-center justify-center gap-4 sm:gap-8">
            <!-- Avatar/Icono grande -->
            <div class="relative">
              <div class="w-20 h-20 sm:w-32 sm:h-32 rounded-full bg-gradient-to-br from-aoe-gold via-amber-500 to-amber-700 flex items-center justify-center text-4xl sm:text-6xl shadow-[0_0_30px_rgba(218,165,32,0.5)] border-4 border-aoe-gold">
                üèÜ
              </div>
              <div class="absolute -bottom-2 -right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                #1
              </div>
            </div>

            <!-- Info del jugador -->
            <div class="text-center">
              <a href={`/players/${topPlayer.id}`} class="block">
                <h3 class="text-2xl sm:text-4xl font-cinzel text-aoe-gold hover:text-aoe-gold-light transition-colors">
                  {topPlayer.username.toUpperCase()}
                </h3>
              </a>
              <p class="text-aoe-cream-dark mt-1 text-sm sm:text-base">
                {getCivilizationFlag(topPlayer.favoriteCiv)} {getCivilizationName(topPlayer.favoriteCiv)}
              </p>
              <p class={`text-base sm:text-lg font-semibold mt-2 ${getTierColor(topPlayer.eloRating)}`}>
                {getRatingTier(topPlayer.eloRating)}
              </p>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-4 gap-2 sm:gap-4 text-center w-full max-w-md">
              <div class="aoe-card px-2 sm:px-4 py-2 sm:py-3">
                <div class="text-lg sm:text-3xl font-cinzel text-aoe-gold">{Math.round(topPlayer.eloRating)}</div>
                <div class="text-[10px] sm:text-xs text-aoe-cream-dark">ELO</div>
              </div>
              <div class="aoe-card px-2 sm:px-4 py-2 sm:py-3">
                <div class="text-lg sm:text-3xl font-cinzel text-green-400">{topPlayerStats.wins}</div>
                <div class="text-[10px] sm:text-xs text-aoe-cream-dark">Wins</div>
              </div>
              <div class="aoe-card px-2 sm:px-4 py-2 sm:py-3">
                <div class="text-lg sm:text-3xl font-cinzel text-red-400">{topPlayerStats.losses}</div>
                <div class="text-[10px] sm:text-xs text-aoe-cream-dark">Losses</div>
              </div>
              <div class="aoe-card px-2 sm:px-4 py-2 sm:py-3">
                <div class="text-lg sm:text-3xl font-cinzel text-aoe-cream">{topPlayerStats.winRate}%</div>
                <div class="text-[10px] sm:text-xs text-aoe-cream-dark">WR</div>
              </div>
            </div>
          </div>

          <!-- Mensaje motivacional -->
          <div class="text-center mt-4 sm:mt-6 pt-3 sm:pt-4 border-t border-aoe-gold/20">
            <p class="text-aoe-cream-dark text-xs sm:text-sm">
              ¬øPod√©s destronarlo? <a href="/matches/new" class="text-aoe-gold hover:underline">Registr√° una partida</a>
            </p>
          </div>
        </div>
      </div>
    )}

    <!-- El Boludo de la Semana -->
    {weeklyLoser && weeklyLoser.player.id !== topPlayer?.id && (
      <div class="aoe-panel relative overflow-hidden border-red-500/30 bg-gradient-to-r from-red-900/20 via-transparent to-red-900/20">
        <div class="relative">
          <div class="flex flex-col items-center gap-4 sm:gap-6 sm:flex-row sm:justify-between">
            <div class="flex flex-col sm:flex-row items-center gap-3 sm:gap-4 text-center sm:text-left">
              <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gradient-to-br from-red-600 via-red-700 to-red-900 flex items-center justify-center text-3xl sm:text-4xl shadow-[0_0_20px_rgba(239,68,68,0.4)] border-4 border-red-500">
                üí©
              </div>
              <div>
                <h3 class="text-xs sm:text-sm text-red-400 uppercase tracking-wider">El Boludo de la Semana</h3>
                <a href={`/players/${weeklyLoser.player.id}`} class="block">
                  <span class="text-xl sm:text-2xl font-cinzel text-red-400 hover:text-red-300">
                    {weeklyLoser.player.username.toUpperCase()}
                  </span>
                </a>
                <p class="text-aoe-cream-dark text-xs sm:text-sm italic max-w-xs">"{weeklyLoser.frase}"</p>
              </div>
            </div>

            <div class="flex gap-3 sm:gap-4 text-center">
              <div class="aoe-card px-3 sm:px-4 py-2 border-red-500/30">
                <div class="text-xl sm:text-2xl font-cinzel text-red-400">{weeklyLoser.losses}</div>
                <div class="text-[10px] sm:text-xs text-aoe-cream-dark">Derrotas</div>
              </div>
              <div class="aoe-card px-3 sm:px-4 py-2 border-green-500/30">
                <div class="text-xl sm:text-2xl font-cinzel text-green-400">{weeklyLoser.wins}</div>
                <div class="text-[10px] sm:text-xs text-aoe-cream-dark">Victorias</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- El Pollera de la Semana -->
    {weeklyPollera && weeklyPollera.player.id !== topPlayer?.id && weeklyPollera.player.id !== weeklyLoser?.player.id && (
      <div class="aoe-panel relative overflow-hidden border-pink-500/30 bg-gradient-to-r from-pink-900/20 via-transparent to-pink-900/20">
        <div class="relative">
          <div class="flex flex-col items-center gap-4 sm:gap-6 sm:flex-row sm:justify-between">
            <div class="flex flex-col sm:flex-row items-center gap-3 sm:gap-4 text-center sm:text-left">
              <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gradient-to-br from-pink-600 via-pink-700 to-purple-900 flex items-center justify-center text-3xl sm:text-4xl shadow-[0_0_20px_rgba(236,72,153,0.4)] border-4 border-pink-500">
                üë†
              </div>
              <div>
                <h3 class="text-xs sm:text-sm text-pink-400 uppercase tracking-wider">El Pollera de la Semana</h3>
                <a href={`/players/${weeklyPollera.player.id}`} class="block">
                  <span class="text-xl sm:text-2xl font-cinzel text-pink-400 hover:text-pink-300">
                    {weeklyPollera.player.username.toUpperCase()}
                  </span>
                </a>
                <p class="text-aoe-cream-dark text-xs sm:text-sm italic max-w-xs">"{weeklyPollera.frase}"</p>
              </div>
            </div>

            <div class="aoe-card px-3 sm:px-4 py-2 border-pink-500/30">
              <div class="text-xl sm:text-2xl font-cinzel text-pink-400">{weeklyPollera.gamesPlayed}</div>
              <div class="text-[10px] sm:text-xs text-aoe-cream-dark">Partidas esta semana</div>
            </div>
          </div>
        </div>
      </div>
    )}

    <div class="text-center">
      <h1 class="aoe-title text-2xl sm:text-4xl mb-2">Clasificaci√≥n General</h1>
      <p class="text-aoe-cream-dark text-sm sm:text-base">Rankings actualizados en tiempo real</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8">
      <div class="lg:col-span-2">
        <div class="aoe-panel">
          <!-- Tabs de filtro -->
          <div class="flex flex-wrap gap-2 mb-4">
            <a
              href="/?ranking=1v1"
              class={`px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg font-cinzel text-xs sm:text-sm transition-all ${rankingType === '1v1' ? 'bg-aoe-gold text-aoe-brown-dark' : 'bg-aoe-brown-light/50 text-aoe-cream hover:bg-aoe-brown-light'}`}
            >
              üèÜ 1v1
            </a>
            <a
              href="/?ranking=teams"
              class={`px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg font-cinzel text-xs sm:text-sm transition-all ${rankingType === 'teams' ? 'bg-aoe-gold text-aoe-brown-dark' : 'bg-aoe-brown-light/50 text-aoe-cream hover:bg-aoe-brown-light'}`}
            >
              ‚öîÔ∏è Teams
            </a>
            <a
              href="/?ranking=ffa"
              class={`px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg font-cinzel text-xs sm:text-sm transition-all ${rankingType === 'ffa' ? 'bg-aoe-gold text-aoe-brown-dark' : 'bg-aoe-brown-light/50 text-aoe-cream hover:bg-aoe-brown-light'}`}
            >
              üëë FFA
            </a>
          </div>

          <h2 class="aoe-title text-lg sm:text-xl mb-3 sm:mb-4">
            {rankingType === '1v1' ? 'üèÜ Rankings 1v1' : rankingType === 'teams' ? '‚öîÔ∏è Rankings Teams' : 'üëë Rankings FFA'}
          </h2>

          {players.length === 0 ? (
            <div class="text-center py-6 sm:py-8 text-aoe-cream-dark">
              <p>No hay jugadores registrados a√∫n.</p>
              <a href="/players" class="text-aoe-gold hover:text-aoe-gold-light">
                Agregar jugadores ‚Üí
              </a>
            </div>
          ) : (
            <div class="overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
              <table class="aoe-table">
                <thead>
                  <tr>
                    <th class="w-10 sm:w-16">#</th>
                    <th>Jugador</th>
                    <th class="text-center">ELO</th>
                    <th class="text-center hidden sm:table-cell">Rango</th>
                  </tr>
                </thead>
                <tbody>
                  {players.map((player, index) => {
                    const currentElo = player[eloField];
                    return (
                      <tr>
                        <td class="font-cinzel text-aoe-gold text-sm sm:text-base">
                          {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : index + 1}
                        </td>
                        <td>
                          <a href={`/players/${player.id}`} class="hover:text-aoe-gold transition-colors text-sm sm:text-base">
                            {player.username}
                          </a>
                        </td>
                        <td class="text-center font-semibold text-aoe-gold text-sm sm:text-base">
                          {Math.round(currentElo)}
                        </td>
                        <td class={`text-center hidden sm:table-cell ${getTierColor(currentElo)}`}>
                          {getRatingTier(currentElo)}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      <div class="lg:col-span-1">
        <div class="aoe-panel">
          <h2 class="aoe-title text-lg sm:text-xl mb-3 sm:mb-4">üìú Partidas Recientes</h2>

          {matchesWithParticipants.length === 0 ? (
            <div class="text-center py-6 sm:py-8 text-aoe-cream-dark">
              <p class="text-sm sm:text-base">No hay partidas registradas.</p>
              <a href="/matches/new" class="text-aoe-gold hover:text-aoe-gold-light text-sm sm:text-base">
                Registrar partida ‚Üí
              </a>
            </div>
          ) : (
            <div class="space-y-3 sm:space-y-4">
              {matchesWithParticipants.map((match) => (
                <div class="aoe-card">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] sm:text-xs text-aoe-cream-dark uppercase">{match.matchType}</span>
                    <span class="text-[10px] sm:text-xs text-aoe-cream-dark">
                      {new Date(match.playedAt).toLocaleDateString('es')}
                    </span>
                  </div>
                  <div class="space-y-1">
                    {match.participants.map((p) => (
                      <div class={`flex justify-between items-center text-xs sm:text-sm ${p.isWinner ? 'text-green-400' : 'text-red-400'}`}>
                        <span>{p.playerName}</span>
                        <span class="text-[10px] sm:text-xs">
                          {p.eloChange > 0 ? '+' : ''}{Math.round(p.eloChange)}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}

          <a href="/matches" class="block text-center mt-3 sm:mt-4 text-aoe-gold hover:text-aoe-gold-light text-xs sm:text-sm">
            Ver todas las partidas ‚Üí
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>
