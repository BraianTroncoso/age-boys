---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';

const allPlayers = await db.users.findAll();
const players = allPlayers.filter(p => p.username !== 'admin');
---

<Layout title="Ruleta de Enfrentamientos">
  <div class="max-w-4xl mx-auto space-y-8">
    <div class="text-center">
      <h1 class="aoe-title text-3xl mb-2">Ruleta de Enfrentamientos</h1>
      <p class="text-aoe-cream-dark">Selecciona jugadores y deja que el destino decida los duelos</p>
    </div>

    {players.length < 2 ? (
      <div class="aoe-panel text-center py-8">
        <span class="text-5xl mb-4 block">⚠️</span>
        <h2 class="aoe-title text-xl mb-2">Jugadores insuficientes</h2>
        <p class="text-aoe-cream-dark mb-4">
          Necesitas al menos 2 jugadores para usar la ruleta.
        </p>
        <a href="/players" class="aoe-btn-primary inline-block">
          Agregar Jugadores
        </a>
      </div>
    ) : (
      <div class="space-y-8">
        <!-- Player Selection -->
        <div class="aoe-panel">
          <h2 class="aoe-title text-xl mb-4">Selecciona los Jugadores</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="playerSelection">
            {players.map(p => (
              <label class="cursor-pointer group">
                <input type="checkbox" value={p.id} data-name={p.username} class="peer hidden player-checkbox" />
                <div class="player-card aoe-card text-center border-2 border-aoe-gold/30 peer-checked:border-aoe-gold peer-checked:bg-gradient-to-br peer-checked:from-aoe-gold/30 peer-checked:to-amber-900/40 peer-checked:shadow-[0_0_20px_rgba(218,165,32,0.6)] transition-all py-3">
                  <span class="player-name text-sm block">{p.username}</span>
                  <span class="check-indicator text-green-400 text-lg">✓</span>
                </div>
              </label>
            ))}
          </div>
          <p class="text-aoe-cream-dark text-sm mt-3 text-center" id="selectedCount">
            0 jugadores seleccionados
          </p>
        </div>

        <!-- Wheel Container -->
        <div class="aoe-panel">
          <div class="relative flex flex-col items-center">
            <!-- Pointer -->
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 z-20">
              <div class="w-0 h-0 border-l-[20px] border-r-[20px] border-t-[30px] border-l-transparent border-r-transparent border-t-aoe-gold drop-shadow-lg"></div>
            </div>

            <!-- Wheel -->
            <div class="relative w-80 h-80 md:w-96 md:h-96">
              <!-- Wooden wheel base -->
              <div class="absolute inset-0 rounded-full bg-gradient-to-br from-amber-800 via-amber-700 to-amber-900 shadow-2xl border-8 border-amber-950" style="box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 0 10px 30px rgba(0,0,0,0.5);">
                <!-- Wood grain texture -->
                <div class="absolute inset-2 rounded-full opacity-20" style="background: repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(139, 69, 19, 0.3) 2px, rgba(139, 69, 19, 0.3) 4px);"></div>
              </div>

              <!-- Spinning wheel with segments -->
              <div id="wheel" class="absolute inset-4 rounded-full overflow-hidden transition-transform duration-[5000ms] ease-out" style="background: conic-gradient(from 0deg, #8B4513, #A0522D, #8B4513, #A0522D, #8B4513, #A0522D, #8B4513, #A0522D);">
                <div id="wheelContent" class="w-full h-full relative">
                  <!-- Player names will be inserted here by JS -->
                </div>
              </div>

              <!-- Center button -->
              <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10">
                <button id="spinBtn" class="w-20 h-20 rounded-full bg-gradient-to-br from-aoe-gold via-amber-500 to-amber-700 shadow-lg border-4 border-amber-800 hover:from-aoe-gold-light hover:to-amber-600 transition-all font-cinzel text-amber-950 font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                  GIRAR
                </button>
              </div>

              <!-- Metal rivets -->
              <div class="absolute inset-0">
                {[0, 45, 90, 135, 180, 225, 270, 315].map(angle => (
                  <div
                    class="absolute w-3 h-3 rounded-full bg-gradient-to-br from-gray-300 to-gray-600 border border-gray-700"
                    style={`top: 50%; left: 50%; transform: rotate(${angle}deg) translateY(-155px) translate(-50%, -50%);`}
                  />
                ))}
              </div>
            </div>

            <!-- Instruction message (below wheel) -->
            <div id="instructionMsg" class="mt-6 text-center">
              <p class="text-aoe-cream-dark font-cinzel">Selecciona al menos 2 jugadores para girar</p>
            </div>

            <!-- Result Display -->
            <div id="resultDisplay" class="mt-8 text-center hidden">
              <div class="aoe-card p-6 bg-aoe-dark/80 border-aoe-gold">
                <h3 class="aoe-title text-xl mb-4 text-aoe-gold">Enfrentamiento</h3>
                <div class="flex items-center justify-center gap-6">
                  <div class="text-center">
                    <div id="player1Name" class="text-2xl font-cinzel text-green-400"></div>
                  </div>
                  <div class="text-aoe-gold text-3xl font-cinzel">VS</div>
                  <div class="text-center">
                    <div id="player2Name" class="text-2xl font-cinzel text-red-400"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Match History from Wheel -->
        <div class="aoe-panel">
          <h2 class="aoe-title text-xl mb-4">Enfrentamientos Generados</h2>
          <div id="matchHistory" class="space-y-2">
            <p class="text-aoe-cream-dark text-center py-4">
              Los enfrentamientos generados aparecerán aquí
            </p>
          </div>
          <div class="flex gap-4 mt-4">
            <button id="clearHistoryBtn" class="aoe-btn flex-1" disabled>
              Limpiar Historial
            </button>
            <button id="spinAgainBtn" class="aoe-btn-primary flex-1" disabled>
              Girar de Nuevo
            </button>
          </div>
        </div>
      </div>
    )}
  </div>
</Layout>

<script define:vars={{ players }}>
  const checkboxes = document.querySelectorAll('.player-checkbox');
  const selectedCountEl = document.getElementById('selectedCount');
  const wheel = document.getElementById('wheel');
  const wheelContent = document.getElementById('wheelContent');
  const spinBtn = document.getElementById('spinBtn');
  const resultDisplay = document.getElementById('resultDisplay');
  const player1Name = document.getElementById('player1Name');
  const player2Name = document.getElementById('player2Name');
  const matchHistory = document.getElementById('matchHistory');
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');
  const spinAgainBtn = document.getElementById('spinAgainBtn');
  const instructionMsg = document.getElementById('instructionMsg');

  let selectedPlayers = [];
  let currentRotation = 0;
  let isSpinning = false;
  let generatedMatches = [];
  let remainingPlayers = [];

  // Colors for wheel segments
  const segmentColors = [
    '#8B4513', '#A0522D', '#CD853F', '#D2691E',
    '#B8860B', '#DAA520', '#8B6914', '#996515'
  ];

  function updateWheel() {
    if (selectedPlayers.length < 2) {
      wheelContent.innerHTML = '';
      instructionMsg?.classList.remove('hidden');
      return;
    }

    instructionMsg?.classList.add('hidden');

    const count = selectedPlayers.length;
    const anglePerSegment = 360 / count;

    // Create conic gradient
    let gradientStops = [];
    selectedPlayers.forEach((p, i) => {
      const color = segmentColors[i % segmentColors.length];
      const start = (i * anglePerSegment);
      const end = ((i + 1) * anglePerSegment);
      gradientStops.push(`${color} ${start}deg ${end}deg`);
    });

    wheel.style.background = `conic-gradient(from 0deg, ${gradientStops.join(', ')})`;

    // Create segment labels
    let labelsHtml = '';
    selectedPlayers.forEach((p, i) => {
      const angle = (i * anglePerSegment) + (anglePerSegment / 2) - 90;
      labelsHtml += `
        <div class="absolute text-amber-100 font-cinzel text-xs md:text-sm font-bold whitespace-nowrap"
             style="top: 50%; left: 50%; transform: rotate(${angle}deg) translateX(60px); transform-origin: 0 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">
          ${p.name.substring(0, 8)}
        </div>
      `;
    });
    wheelContent.innerHTML = labelsHtml;
  }

  function getSelectedPlayers() {
    return Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => ({
        id: parseInt(cb.value),
        name: cb.dataset.name
      }));
  }

  function updateSelectedCount() {
    selectedPlayers = getSelectedPlayers();
    selectedCountEl.textContent = `${selectedPlayers.length} jugadores seleccionados`;
    spinBtn.disabled = selectedPlayers.length < 2;
    updateWheel();

    // Reset remaining players when selection changes
    remainingPlayers = [...selectedPlayers];
  }

  function spin() {
    if (isSpinning || remainingPlayers.length < 2) return;

    isSpinning = true;
    spinBtn.disabled = true;
    spinAgainBtn.disabled = true;
    resultDisplay.classList.add('hidden');

    // Random rotation (minimum 5 full rotations + random angle)
    const extraRotation = 1800 + Math.random() * 1800;
    currentRotation += extraRotation;
    wheel.style.transform = `rotate(${currentRotation}deg)`;

    // After spin completes
    setTimeout(() => {
      // Select 2 random players from remaining
      const shuffled = [...remainingPlayers].sort(() => Math.random() - 0.5);
      const p1 = shuffled[0];
      const p2 = shuffled[1];

      // Remove selected players from remaining
      remainingPlayers = remainingPlayers.filter(p => p.id !== p1.id && p.id !== p2.id);

      // Show result
      player1Name.textContent = p1.name;
      player2Name.textContent = p2.name;
      resultDisplay.classList.remove('hidden');

      // Add to history
      generatedMatches.push({ player1: p1, player2: p2 });
      updateMatchHistory();

      isSpinning = false;
      spinAgainBtn.disabled = remainingPlayers.length < 2;
      spinBtn.disabled = remainingPlayers.length < 2;
      clearHistoryBtn.disabled = false;
    }, 5000);
  }

  function updateMatchHistory() {
    if (generatedMatches.length === 0) {
      matchHistory.innerHTML = `
        <p class="text-aoe-cream-dark text-center py-4">
          Los enfrentamientos generados aparecerán aquí
        </p>
      `;
      return;
    }

    let html = '';
    generatedMatches.forEach((match, i) => {
      html += `
        <div class="flex items-center justify-between p-3 bg-aoe-dark/50 rounded border border-aoe-gold/20">
          <span class="text-aoe-cream-dark text-sm">Duelo ${i + 1}</span>
          <div class="flex items-center gap-3">
            <span class="text-green-400 font-cinzel">${match.player1.name}</span>
            <span class="text-aoe-gold text-sm">vs</span>
            <span class="text-red-400 font-cinzel">${match.player2.name}</span>
          </div>
        </div>
      `;
    });

    if (remainingPlayers.length === 1) {
      html += `
        <div class="mt-4 p-3 bg-aoe-gold/10 rounded border border-aoe-gold/30 text-center">
          <span class="text-aoe-gold font-cinzel">${remainingPlayers[0].name}</span>
          <span class="text-aoe-cream-dark text-sm ml-2">queda sin oponente</span>
        </div>
      `;
    } else if (remainingPlayers.length === 0 && generatedMatches.length > 0) {
      html += `
        <div class="mt-4 p-3 bg-green-900/20 rounded border border-green-500/30 text-center">
          <span class="text-green-400">Todos los enfrentamientos han sido asignados</span>
        </div>
      `;
    }

    matchHistory.innerHTML = html;
  }

  function clearHistory() {
    generatedMatches = [];
    remainingPlayers = [...selectedPlayers];
    updateMatchHistory();
    resultDisplay.classList.add('hidden');
    spinBtn.disabled = selectedPlayers.length < 2;
    spinAgainBtn.disabled = true;
    clearHistoryBtn.disabled = true;
  }

  // Event listeners
  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
  });

  spinBtn?.addEventListener('click', spin);
  spinAgainBtn?.addEventListener('click', spin);
  clearHistoryBtn?.addEventListener('click', clearHistory);

  // Initial setup
  updateSelectedCount();
</script>

<style>
  #wheel {
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  }

  @keyframes pulse-gold {
    0%, 100% { box-shadow: 0 0 10px rgba(218, 165, 32, 0.5); }
    50% { box-shadow: 0 0 20px rgba(218, 165, 32, 0.8); }
  }

  #resultDisplay .aoe-card {
    animation: pulse-gold 2s infinite;
  }

  /* Player selection styling */
  .player-checkbox:checked + .player-card {
    border-color: #DAA520 !important;
    background: linear-gradient(135deg, rgba(218, 165, 32, 0.3), rgba(139, 69, 19, 0.4)) !important;
    box-shadow: 0 0 20px rgba(218, 165, 32, 0.6), inset 0 0 10px rgba(218, 165, 32, 0.2) !important;
  }

  .player-checkbox:checked + .player-card .player-name {
    color: #DAA520;
    font-weight: 600;
    text-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
  }
</style>
