---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';
import { getCivilizationName } from '../lib/civilizations';

const players = await db.users.findAll();

// Get query params
const url = new URL(Astro.request.url);
const player1Id = parseInt(url.searchParams.get('player1') || url.searchParams.get('player') || '0');
const player2Id = parseInt(url.searchParams.get('player2') || '0');

let h2hData = null;

if (player1Id && player2Id && player1Id !== player2Id) {
  const player1 = await db.users.findById(player1Id);
  const player2 = await db.users.findById(player2Id);

  if (player1 && player2) {
    // Get all 1v1 matches
    const allMatchesRaw = await db.matches.findAll();
    const allMatches = allMatchesRaw
      .filter(m => m.matchType === '1v1')
      .sort((a, b) => new Date(b.playedAt).getTime() - new Date(a.playedAt).getTime());

    // Filter matches that have both players
    const matchDetails = [];
    for (const match of allMatches) {
      const participants = await db.participants.findByMatchId(match.id);

      const p1Data = participants.find(p => p.playerId === player1Id);
      const p2Data = participants.find(p => p.playerId === player2Id);

      if (p1Data && p2Data) {
        matchDetails.push({
          matchId: match.id,
          playedAt: match.playedAt,
          player1: {
            playerId: p1Data.playerId,
            civilization: p1Data.civilization,
            isWinner: p1Data.isWinner,
            eloChange: p1Data.eloChange,
          },
          player2: {
            playerId: p2Data.playerId,
            civilization: p2Data.civilization,
            isWinner: p2Data.isWinner,
            eloChange: p2Data.eloChange,
          },
        });
      }
    }

    // Calculate stats
    const player1Wins = matchDetails.filter(m => m.player1?.isWinner).length;
    const player2Wins = matchDetails.filter(m => m.player2?.isWinner).length;

    h2hData = {
      player1,
      player2,
      matches: matchDetails,
      player1Wins,
      player2Wins,
      total: matchDetails.length,
    };
  }
}
---

<Layout title="Head-to-Head">
  <div class="space-y-4 sm:space-y-8">
    <div class="text-center">
      <h1 class="aoe-title text-2xl sm:text-3xl mb-2">Head-to-Head</h1>
      <p class="text-aoe-cream-dark text-sm sm:text-base">Compara el historial 1v1</p>
    </div>

    <!-- Player Selection -->
    <div class="aoe-panel">
      <form method="GET" class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-stretch sm:items-end">
        <div class="flex-1">
          <label class="block text-xs sm:text-sm font-semibold text-aoe-cream mb-1 sm:mb-2">
            Jugador 1
          </label>
          <select name="player1" class="aoe-select text-sm" required>
            <option value="">Seleccionar</option>
            {players.map(p => (
              <option value={p.id} selected={p.id === player1Id}>{p.username}</option>
            ))}
          </select>
        </div>

        <div class="text-center text-aoe-gold text-xl sm:text-2xl font-cinzel hidden sm:block">
          VS
        </div>

        <div class="flex-1">
          <label class="block text-xs sm:text-sm font-semibold text-aoe-cream mb-1 sm:mb-2">
            Jugador 2
          </label>
          <select name="player2" class="aoe-select text-sm" required>
            <option value="">Seleccionar</option>
            {players.map(p => (
              <option value={p.id} selected={p.id === player2Id}>{p.username}</option>
            ))}
          </select>
        </div>

        <button type="submit" class="aoe-btn-primary text-sm sm:text-base">
          Comparar
        </button>
      </form>
    </div>

    {/* No comparison selected */}
    {!h2hData && !player1Id && !player2Id && (
      <div class="aoe-panel text-center py-8 sm:py-12">
        <span class="text-4xl sm:text-6xl mb-3 sm:mb-4 block">‚öîÔ∏è</span>
        <h2 class="aoe-title text-lg sm:text-xl mb-2">Selecciona dos jugadores</h2>
        <p class="text-aoe-cream-dark text-sm sm:text-base">
          Elige dos jugadores para ver su historial
        </p>
      </div>
    )}

    {/* Same player selected */}
    {player1Id && player2Id && player1Id === player2Id && (
      <div class="aoe-panel text-center py-6 sm:py-8">
        <span class="text-3xl sm:text-4xl mb-3 sm:mb-4 block">ü§î</span>
        <p class="text-aoe-cream-dark text-sm sm:text-base">
          Selecciona dos jugadores diferentes
        </p>
      </div>
    )}

    {/* H2H Results */}
    {h2hData && (
      <div class="space-y-4 sm:space-y-6">
        {/* Score Card */}
        <div class="aoe-panel">
          <div class="grid grid-cols-3 gap-2 sm:gap-4 items-center">
            <div class="text-center">
              <a href={`/players/${h2hData.player1.id}`} class="aoe-title text-sm sm:text-2xl hover:text-aoe-gold-light block truncate">
                {h2hData.player1.username}
              </a>
              <p class="text-aoe-cream-dark text-[10px] sm:text-sm">
                {Math.round(h2hData.player1.eloRating)}
              </p>
            </div>

            <div class="text-center">
              <div class="flex items-center justify-center gap-1 sm:gap-4 text-2xl sm:text-4xl font-cinzel">
                <span class={h2hData.player1Wins > h2hData.player2Wins ? 'text-green-400' : 'text-aoe-cream'}>
                  {h2hData.player1Wins}
                </span>
                <span class="text-aoe-gold text-lg sm:text-4xl">-</span>
                <span class={h2hData.player2Wins > h2hData.player1Wins ? 'text-green-400' : 'text-aoe-cream'}>
                  {h2hData.player2Wins}
                </span>
              </div>
              <p class="text-aoe-cream-dark text-[10px] sm:text-sm mt-1 sm:mt-2">
                {h2hData.total} partidas
              </p>
            </div>

            <div class="text-center">
              <a href={`/players/${h2hData.player2.id}`} class="aoe-title text-sm sm:text-2xl hover:text-aoe-gold-light block truncate">
                {h2hData.player2.username}
              </a>
              <p class="text-aoe-cream-dark text-[10px] sm:text-sm">
                {Math.round(h2hData.player2.eloRating)}
              </p>
            </div>
          </div>

          {/* Win rate bars */}
          {h2hData.total > 0 && (
            <div class="mt-4 sm:mt-6">
              <div class="h-3 sm:h-4 rounded-full overflow-hidden flex bg-aoe-dark">
                <div
                  class="bg-gradient-to-r from-green-600 to-green-400 transition-all"
                  style={`width: ${(h2hData.player1Wins / h2hData.total) * 100}%`}
                />
                <div
                  class="bg-gradient-to-r from-red-400 to-red-600 transition-all"
                  style={`width: ${(h2hData.player2Wins / h2hData.total) * 100}%`}
                />
              </div>
              <div class="flex justify-between mt-1 sm:mt-2 text-[10px] sm:text-sm">
                <span class="text-green-400">
                  {Math.round((h2hData.player1Wins / h2hData.total) * 100)}%
                </span>
                <span class="text-red-400">
                  {Math.round((h2hData.player2Wins / h2hData.total) * 100)}%
                </span>
              </div>
            </div>
          )}
        </div>

        {/* Match History */}
        {h2hData.matches.length > 0 ? (
          <div class="aoe-panel">
            <h2 class="aoe-title text-lg sm:text-xl mb-3 sm:mb-4">üìú Historial</h2>
            <div class="space-y-2 sm:hidden">
              {/* Mobile: Stack layout */}
              {h2hData.matches.map((match) => (
                <div class="bg-aoe-dark/50 rounded p-3 flex items-center justify-between">
                  <div class="text-center">
                    <span class={`text-sm font-semibold ${match.player1?.isWinner ? 'text-green-400' : 'text-red-400'}`}>
                      {match.player1?.isWinner ? 'üèÜ' : 'üíÄ'}
                    </span>
                    <span class={`text-xs ml-1 ${match.player1?.isWinner ? 'text-green-400' : 'text-red-400'}`}>
                      {match.player1?.eloChange && match.player1.eloChange > 0 ? '+' : ''}{match.player1?.eloChange ? Math.round(match.player1.eloChange) : 0}
                    </span>
                  </div>
                  <div class="text-[10px] text-aoe-cream-dark">
                    {match.playedAt ? new Date(match.playedAt).toLocaleDateString('es', { day: 'numeric', month: 'short' }) : '-'}
                  </div>
                  <div class="text-center">
                    <span class={`text-xs mr-1 ${match.player2?.isWinner ? 'text-green-400' : 'text-red-400'}`}>
                      {match.player2?.eloChange && match.player2.eloChange > 0 ? '+' : ''}{match.player2?.eloChange ? Math.round(match.player2.eloChange) : 0}
                    </span>
                    <span class={`text-sm font-semibold ${match.player2?.isWinner ? 'text-green-400' : 'text-red-400'}`}>
                      {match.player2?.isWinner ? 'üèÜ' : 'üíÄ'}
                    </span>
                  </div>
                </div>
              ))}
            </div>
            <div class="overflow-x-auto hidden sm:block">
              <table class="aoe-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>{h2hData.player1.username}</th>
                    <th class="text-center">Resultado</th>
                    <th>{h2hData.player2.username}</th>
                  </tr>
                </thead>
                <tbody>
                  {h2hData.matches.map((match) => (
                    <tr>
                      <td class="text-aoe-cream-dark text-sm">
                        {match.playedAt ? new Date(match.playedAt).toLocaleDateString('es') : '-'}
                      </td>
                      <td>
                        <span class={`text-sm ${match.player1?.isWinner ? 'text-green-400' : 'text-red-400'}`}>
                          {getCivilizationName(match.player1?.civilization || '')}
                        </span>
                        <span class="text-xs text-aoe-cream-dark ml-2">
                          ({match.player1?.eloChange && match.player1.eloChange > 0 ? '+' : ''}{match.player1?.eloChange ? Math.round(match.player1.eloChange) : 0})
                        </span>
                      </td>
                      <td class="text-center">
                        <span class={`inline-block px-1 py-0.5 text-xs rounded ${match.player1?.isWinner ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>
                          {match.player1?.isWinner ? 'üèÜ' : 'üíÄ'}
                        </span>
                        <span class="mx-1 text-aoe-gold text-xs">vs</span>
                        <span class={`inline-block px-1 py-0.5 text-xs rounded ${match.player2?.isWinner ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>
                          {match.player2?.isWinner ? 'üèÜ' : 'üíÄ'}
                        </span>
                      </td>
                      <td>
                        <span class={`text-sm ${match.player2?.isWinner ? 'text-green-400' : 'text-red-400'}`}>
                          {getCivilizationName(match.player2?.civilization || '')}
                        </span>
                        <span class="text-xs text-aoe-cream-dark ml-2">
                          ({match.player2?.eloChange && match.player2.eloChange > 0 ? '+' : ''}{match.player2?.eloChange ? Math.round(match.player2.eloChange) : 0})
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        ) : (
          <div class="aoe-panel text-center py-6 sm:py-8">
            <span class="text-3xl sm:text-4xl mb-3 sm:mb-4 block">ü§∑</span>
            <p class="text-aoe-cream-dark text-sm sm:text-base">
              No han jugado 1v1 entre ellos
            </p>
          </div>
        )}
      </div>
    )}
  </div>
</Layout>
