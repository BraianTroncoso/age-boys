---
import Layout from '../../layouts/Layout.astro';
import { db } from '../../db';
import { getCivilizationName } from '../../lib/civilizations';

// PaginaciÃ³n
const ITEMS_PER_PAGE = 5;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');

// Obtener partidas paginadas con participantes en una sola consulta optimizada
const { matches: paginatedMatches, total: totalMatches } = await db.matches.findPaginatedWithParticipants(currentPage, ITEMS_PER_PAGE);

const totalPages = Math.ceil(totalMatches / ITEMS_PER_PAGE);
const validPage = Math.max(1, Math.min(currentPage, totalPages || 1));

// Mapear a formato esperado por el template
const matchesWithParticipants = paginatedMatches.map(match => ({
  ...match,
  createdByName: (match as any).creatorName || null
}));

// Generar array de pÃ¡ginas para mostrar
const getPageNumbers = () => {
  const pages: (number | string)[] = [];
  if (totalPages <= 7) {
    for (let i = 1; i <= totalPages; i++) pages.push(i);
  } else {
    if (validPage <= 3) {
      pages.push(1, 2, 3, 4, '...', totalPages);
    } else if (validPage >= totalPages - 2) {
      pages.push(1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages);
    } else {
      pages.push(1, '...', validPage - 1, validPage, validPage + 1, '...', totalPages);
    }
  }
  return pages;
};
---

<Layout title="Historial de Partidas">
  <div class="space-y-4 sm:space-y-8">
    <div class="text-center">
      <h1 class="aoe-title text-2xl sm:text-3xl mb-2">Historial de Partidas</h1>
      <p class="text-aoe-cream-dark mb-3 sm:mb-4 text-sm sm:text-base">{totalMatches} partidas registradas</p>
      <a href="/matches/new" class="aoe-btn-primary text-sm sm:text-base">+ Nueva Partida</a>
    </div>

    {totalMatches === 0 ? (
      <div class="aoe-panel text-center py-8 sm:py-12">
        <span class="text-4xl sm:text-6xl mb-3 sm:mb-4 block">ğŸ“œ</span>
        <h2 class="aoe-title text-lg sm:text-xl mb-2">Sin partidas</h2>
        <p class="text-aoe-cream-dark mb-3 sm:mb-4 text-sm sm:text-base">No hay partidas registradas aÃºn</p>
        <a href="/matches/new" class="aoe-btn-primary inline-block text-sm sm:text-base">Registrar Primera Partida</a>
      </div>
    ) : (
      <div class="flex flex-col" style="min-height: calc(100vh - 200px);">
        <div class="space-y-3 sm:space-y-4 flex-grow">
          {matchesWithParticipants.map((match) => {
            const winners = match.participants.filter(p => p.isWinner);
            const losers = match.participants.filter(p => !p.isWinner);
            return (
              <div class="aoe-panel">
                <div class="flex justify-between items-start mb-3 sm:mb-4">
                  <div class="flex items-center gap-2 sm:gap-4">
                    <span class="text-xl sm:text-2xl">{match.matchType === '1v1' ? 'âš”ï¸' : match.matchType === 'ffa' ? 'ğŸ‘‘' : 'âš”ï¸'}</span>
                    <div>
                      <span class="font-cinzel text-base sm:text-lg text-aoe-gold uppercase">{match.matchType}</span>
                      <p class="text-xs sm:text-sm text-aoe-cream-dark">{new Date(match.playedAt).toLocaleDateString('es', { day: 'numeric', month: 'short' })}</p>
                    </div>
                  </div>
                  {match.createdByName && (
                    <div class="text-right">
                      <p class="text-[10px] sm:text-xs text-aoe-cream-dark">Registrado por</p>
                      <p class="text-xs sm:text-sm text-aoe-gold">{match.createdByName}</p>
                    </div>
                  )}
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                  <div class="bg-green-900/20 border border-green-500/30 rounded p-3 sm:p-4">
                    <h4 class="text-green-400 font-semibold mb-2 sm:mb-3 flex items-center gap-2 text-sm sm:text-base">
                      <span>ğŸ†</span>{winners.length > 1 ? 'Ganadores' : 'Ganador'}
                    </h4>
                    <div class="space-y-1.5 sm:space-y-2">
                      {winners.map((p) => (
                        <div class="flex justify-between items-center text-sm">
                          <div class="min-w-0">
                            <a href={`/players/${p.playerId}`} class="text-aoe-cream hover:text-aoe-gold truncate block">{p.playerName}</a>
                          </div>
                          <span class="text-green-400 text-xs sm:text-sm font-semibold flex-shrink-0 ml-2">+{Math.round(p.eloChange)}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div class="bg-red-900/20 border border-red-500/30 rounded p-3 sm:p-4">
                    <h4 class="text-red-400 font-semibold mb-2 sm:mb-3 flex items-center gap-2 text-sm sm:text-base">
                      <span>ğŸ’€</span>{losers.length > 1 ? 'Perdedores' : 'Perdedor'}
                    </h4>
                    <div class="space-y-1.5 sm:space-y-2">
                      {losers.map((p) => (
                        <div class="flex justify-between items-center text-sm">
                          <div class="min-w-0">
                            <a href={`/players/${p.playerId}`} class="text-aoe-cream hover:text-aoe-gold truncate block">{p.playerName}</a>
                          </div>
                          <span class="text-red-400 text-xs sm:text-sm font-semibold flex-shrink-0 ml-2">{Math.round(p.eloChange)}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <!-- Paginacion siempre al fondo -->
        <div class="mt-auto pt-4 sm:pt-8 pb-[15px]">
          {totalPages > 1 && (
            <div class="flex flex-wrap justify-center items-center gap-2">
            {validPage > 1 ? (
              <a
                href={`/matches?page=${validPage - 1}`}
                class="px-2 sm:px-3 py-1.5 sm:py-2 rounded bg-aoe-dark border border-aoe-gold/30 text-aoe-cream hover:bg-aoe-gold/20 transition-colors text-xs sm:text-sm"
              >
                â†
              </a>
            ) : (
              <span class="px-2 sm:px-3 py-1.5 sm:py-2 rounded bg-aoe-dark/50 border border-aoe-gold/10 text-aoe-cream-dark cursor-not-allowed text-xs sm:text-sm">
                â†
              </span>
            )}

            <div class="flex gap-1">
              {getPageNumbers().map((page) => (
                typeof page === 'number' ? (
                  <a
                    href={`/matches?page=${page}`}
                    class={`w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded border transition-colors text-xs sm:text-sm ${
                      page === validPage
                        ? 'bg-aoe-gold text-aoe-dark font-bold border-aoe-gold'
                        : 'bg-aoe-dark border-aoe-gold/30 text-aoe-cream hover:bg-aoe-gold/20'
                    }`}
                  >
                    {page}
                  </a>
                ) : (
                  <span class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center text-aoe-cream-dark text-xs sm:text-sm">
                    {page}
                  </span>
                )
              ))}
            </div>

            {validPage < totalPages ? (
              <a
                href={`/matches?page=${validPage + 1}`}
                class="px-2 sm:px-3 py-1.5 sm:py-2 rounded bg-aoe-dark border border-aoe-gold/30 text-aoe-cream hover:bg-aoe-gold/20 transition-colors text-xs sm:text-sm"
              >
                â†’
              </a>
            ) : (
              <span class="px-2 sm:px-3 py-1.5 sm:py-2 rounded bg-aoe-dark/50 border border-aoe-gold/10 text-aoe-cream-dark cursor-not-allowed text-xs sm:text-sm">
                â†’
              </span>
            )}
            </div>
          )}

          {totalPages > 1 && (
            <p class="text-center text-aoe-cream-dark text-xs sm:text-sm mt-2">
              PÃ¡gina {validPage} de {totalPages}
            </p>
          )}
        </div>
      </div>
    )}
  </div>
</Layout>
