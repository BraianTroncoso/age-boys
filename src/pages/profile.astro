---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';
import { civilizations, getCivilizationName, getCivilizationFlagUrl, getCivilizationColors } from '../lib/civilizations';
import { getRatingTier, getTierColor } from '../lib/elo';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

// Obtener participaciones del usuario
const participations = await db.participants.findByPlayerId(user.id);
const totalMatches = participations.length;
const wins = participations.filter(p => p.isWinner).length;
const winRate = totalMatches > 0 ? Math.round((wins / totalMatches) * 100) : 0;

const [color1, color2] = getCivilizationColors(user.favoriteCiv);
---

<Layout title="Mi Perfil">
  <div class="max-w-2xl mx-auto space-y-8">
    <div class="text-center">
      <h1 class="aoe-title text-3xl mb-2">Mi Perfil</h1>
      <p class="text-aoe-cream-dark">Gestiona tu información de jugador</p>
    </div>

    <div
      class="aoe-panel relative overflow-hidden"
      style={`background: linear-gradient(135deg, ${color1}15 0%, transparent 50%, ${color2}15 100%);`}
    >
      <!-- Background flag -->
      <img
        src={getCivilizationFlagUrl(user.favoriteCiv, 320)}
        alt=""
        class="absolute -right-8 -top-8 w-48 h-auto opacity-20 pointer-events-none select-none blur-[1px]"
      />
      <!-- Color accent bar -->
      <div
        class="absolute top-0 left-0 right-0 h-1"
        style={`background: linear-gradient(90deg, ${color1}, ${color2});`}
      ></div>

      <div class="relative z-10">
        <div class="flex items-center gap-6 mb-6">
          <div class="w-20 h-20 rounded-full bg-aoe-gold/20 flex items-center justify-center border-2 border-aoe-gold overflow-hidden">
            <img src={getCivilizationFlagUrl(user.favoriteCiv, 80)} alt={getCivilizationName(user.favoriteCiv)} class="w-full h-full object-cover" />
          </div>
          <div>
            <h2 class="aoe-title text-2xl">{user.username}</h2>
            <p class={`${getTierColor(user.eloRating)}`}>{getRatingTier(user.eloRating)}</p>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="aoe-stat">
            <div class="aoe-stat-value">{Math.round(user.eloRating)}</div>
            <div class="aoe-stat-label">ELO 1v1</div>
          </div>
          <div class="aoe-stat">
            <div class="aoe-stat-value">{Math.round(user.eloTeams)}</div>
            <div class="aoe-stat-label">ELO Equipos</div>
          </div>
          <div class="aoe-stat">
            <div class="aoe-stat-value">{Math.round(user.eloFfa)}</div>
            <div class="aoe-stat-label">ELO FFA</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="aoe-stat">
            <div class="aoe-stat-value">{totalMatches}</div>
            <div class="aoe-stat-label">Partidas</div>
          </div>
          <div class="aoe-stat">
            <div class="aoe-stat-value text-green-400">{wins}</div>
            <div class="aoe-stat-label">Victorias</div>
          </div>
          <div class="aoe-stat">
            <div class="aoe-stat-value">{winRate}%</div>
            <div class="aoe-stat-label">Win Rate</div>
          </div>
        </div>
      </div>
    </div>

    <div class="aoe-panel">
      <h3 class="aoe-title text-xl mb-4">Editar Perfil</h3>

      <form id="profileForm" class="space-y-4">
        <div>
          <label for="favoriteCiv" class="block text-sm font-semibold text-aoe-cream mb-2">
            Civilizacion Favorita
          </label>
          <select id="favoriteCiv" name="favoriteCiv" class="aoe-select">
            {civilizations.map(civ => (
              <option value={civ.id} selected={civ.id === user.favoriteCiv}>
                {civ.flag} {civ.name}
              </option>
            ))}
          </select>
        </div>

        <div id="profileMessage" class="hidden text-sm text-center p-2 rounded"></div>

        <button type="submit" class="aoe-btn-primary w-full">
          Guardar Cambios
        </button>

        <a href={`/players/${user.id}`} class="block text-right text-aoe-gold hover:text-aoe-gold-light mt-4">
          Ver mi perfil publico →
        </a>
      </form>
    </div>

    {user.isAdmin === 1 && (
      <div class="aoe-panel border-red-500/30">
        <h3 class="aoe-title text-xl mb-4 text-red-400">Panel de Administracion</h3>
        <p class="text-aoe-cream-dark text-sm mb-4">Eliminar partidas y torneos revierte automaticamente los cambios de ELO.</p>

        <!-- Lista de Torneos -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-aoe-cream mb-2">Torneos</h4>
          <div id="adminTournaments" class="space-y-2 max-h-60 overflow-y-auto">
            <p class="text-aoe-cream-dark text-sm">Cargando...</p>
          </div>
        </div>

        <!-- Lista de Partidas Recientes -->
        <div>
          <h4 class="text-lg font-semibold text-aoe-cream mb-2">Partidas Recientes</h4>
          <div id="adminMatches" class="space-y-2 max-h-60 overflow-y-auto">
            <p class="text-aoe-cream-dark text-sm">Cargando...</p>
          </div>
        </div>
      </div>
    )}
  </div>
</Layout>

<script>
  const form = document.getElementById('profileForm') as HTMLFormElement;
  const messageDiv = document.getElementById('profileMessage') as HTMLDivElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageDiv.classList.add('hidden');

    const formData = new FormData(form);
    const data = {
      favoriteCiv: formData.get('favoriteCiv'),
    };

    try {
      const response = await fetch('/api/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        messageDiv.textContent = 'Perfil actualizado correctamente';
        messageDiv.className = 'text-sm text-center p-2 rounded bg-green-900/20 text-green-400';
        messageDiv.classList.remove('hidden');
      } else {
        messageDiv.textContent = result.error || 'Error al actualizar';
        messageDiv.className = 'text-sm text-center p-2 rounded bg-red-900/20 text-red-400';
        messageDiv.classList.remove('hidden');
      }
    } catch (err) {
      messageDiv.textContent = 'Error de conexion';
      messageDiv.className = 'text-sm text-center p-2 rounded bg-red-900/20 text-red-400';
      messageDiv.classList.remove('hidden');
    }
  });

  // Admin panel functionality
  const adminTournaments = document.getElementById('adminTournaments');
  const adminMatches = document.getElementById('adminMatches');

  if (adminTournaments && adminMatches) {
    loadAdminData();
  }

  async function loadAdminData() {
    try {
      const response = await fetch('/api/admin/list');
      const data = await response.json();

      if (data.error) {
        adminTournaments!.innerHTML = `<p class="text-red-400 text-sm">${data.error}</p>`;
        adminMatches!.innerHTML = `<p class="text-red-400 text-sm">${data.error}</p>`;
        return;
      }

      // Renderizar torneos
      if (data.tournaments.length === 0) {
        adminTournaments!.innerHTML = '<p class="text-aoe-cream-dark text-sm">No hay torneos</p>';
      } else {
        adminTournaments!.innerHTML = data.tournaments.map((t: any) => `
          <div class="flex justify-between items-center bg-aoe-brown-light/30 p-2 rounded">
            <div>
              <span class="text-aoe-cream text-sm">${t.name}</span>
              <span class="text-aoe-cream-dark text-xs ml-2">(${t.size} jugadores, ${t.status})</span>
              ${!t.affectsElo ? '<span class="text-pink-400 text-xs ml-1">[Sin ELO]</span>' : ''}
            </div>
            <button
              onclick="deleteTournament(${t.id}, '${t.name.replace(/'/g, "\\'")}')"
              class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded"
            >
              Eliminar
            </button>
          </div>
        `).join('');
      }

      // Renderizar partidas
      if (data.matches.length === 0) {
        adminMatches!.innerHTML = '<p class="text-aoe-cream-dark text-sm">No hay partidas</p>';
      } else {
        adminMatches!.innerHTML = data.matches.map((m: any) => {
          const players = m.participants.map((p: any) =>
            `<span class="${p.isWinner ? 'text-green-400' : 'text-red-400'}">${p.playerName}</span>`
          ).join(' vs ');
          const date = new Date(m.playedAt).toLocaleDateString('es');
          return `
            <div class="flex justify-between items-center bg-aoe-brown-light/30 p-2 rounded">
              <div>
                <span class="text-aoe-cream-dark text-xs">${m.matchType} - ${date}</span>
                <div class="text-sm">${players}</div>
              </div>
              <button
                onclick="deleteMatch(${m.id})"
                class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded"
              >
                Eliminar
              </button>
            </div>
          `;
        }).join('');
      }
    } catch (err) {
      adminTournaments!.innerHTML = '<p class="text-red-400 text-sm">Error al cargar</p>';
      adminMatches!.innerHTML = '<p class="text-red-400 text-sm">Error al cargar</p>';
    }
  }

  (window as any).deleteTournament = async function(id: number, name: string) {
    if (!confirm(`¿Seguro que queres eliminar el torneo "${name}"? Se revertira el ELO si aplica.`)) {
      return;
    }

    try {
      const response = await fetch('/api/admin/delete-tournament', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tournamentId: id })
      });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadAdminData();
      } else {
        alert('Error: ' + result.error);
      }
    } catch (err) {
      alert('Error de conexion');
    }
  };

  (window as any).deleteMatch = async function(id: number) {
    if (!confirm(`¿Seguro que queres eliminar la partida #${id}? Se revertira el ELO.`)) {
      return;
    }

    try {
      const response = await fetch('/api/admin/delete-match', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ matchId: id })
      });
      const result = await response.json();

      if (result.success) {
        alert(result.message);
        loadAdminData();
      } else {
        alert('Error: ' + result.error);
      }
    } catch (err) {
      alert('Error de conexion');
    }
  };
</script>
